version: '3.8'

services:
  postgres:
    image: postgres:15
    restart: unless-stopped
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=delivery
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  api-gateway:
    image: python:3.11-slim
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./services/api_gateway/:/app
      - ./shared/:/app/shared
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/delivery
      - SECRET_KEY=${SECRET_KEY:-demo-secret-key-change-in-production}
      - BOOKING_SERVICE_URL=http://booking-service:8100
      - AUTH_SERVICE_URL=http://auth-service:8600
    command: /bin/sh -c "pip install -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8000"
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy

  auth-service:
    image: python:3.11-slim
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./services/auth_service/:/app
      - ./shared/:/app/shared
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/delivery
      - SECRET_KEY=${SECRET_KEY:-demo-secret-key-change-in-production}
    command: /bin/sh -c "pip install -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8600"
    ports:
      - "8600:8600"
    depends_on:
      postgres:
        condition: service_healthy

  booking-service:
    image: python:3.11-slim
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./services/booking_service/:/app
      - ./shared/:/app/shared
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/delivery
      - SECRET_KEY=${SECRET_KEY:-demo-secret-key-change-in-production}
      - GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}
      - PAYMENT_SERVICE_URL=http://payment-service:8200
      - NOTIFICATION_SERVICE_URL=http://notification-service:8400
    command: /bin/sh -c "pip install -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8100"
    ports:
      - "8100:8100"
    depends_on:
      postgres:
        condition: service_healthy
      payment-service:
        condition: service_started

  payment-service:
    image: python:3.11-slim
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./services/payment_service/:/app
      - ./shared/:/app/shared
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/delivery
      - SECRET_KEY=${SECRET_KEY:-demo-secret-key-change-in-production}
      - API_HOST=payment-service
      - API_PORT=8200
      - PLATFORM_FEE_PERCENT=${PLATFORM_FEE_PERCENT}
      - HUBTEL_CLIENT_ID=${HUBTEL_CLIENT_ID}
      - HUBTEL_CLIENT_SECRET=${HUBTEL_CLIENT_SECRET}
      - HUBTEL_PAYMENT_CLIENT_ID=${HUBTEL_PAYMENT_CLIENT_ID}
      - HUBTEL_PAYMENT_CLIENT_SECRET=${HUBTEL_PAYMENT_CLIENT_SECRET}
      - HUBTEL_MERCHANT_ACCOUNT=${HUBTEL_MERCHANT_ACCOUNT}
      - HUBTEL_CALLBACK_URL=${HUBTEL_CALLBACK_URL:-http://localhost:8200}
      - HUBTEL_WEBHOOK_SECRET=${HUBTEL_WEBHOOK_SECRET:-}
      - NOTIFICATION_SERVICE_URL=http://notification-service:8400
      - ORDER_SERVICE_URL=http://order-service:8500
    command: /bin/sh -c "pip install -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8200"
    ports:
      - "8200:8200"
    depends_on:
      postgres:
        condition: service_healthy

  tracking-service:
    image: python:3.11-slim
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./services/tracking_service/:/app
      - ./shared/:/app/shared
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/delivery
      - SECRET_KEY=${SECRET_KEY:-demo-secret-key-change-in-production}
      - TRACKING_TTL_SECONDS=86400
      - NOTIFICATION_SERVICE_URL=http://notification-service:8400
    command: /bin/sh -c "pip install -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8300"
    ports:
      - "8300:8300"
    depends_on:
      postgres:
        condition: service_healthy

  order-service:
    image: python:3.11-slim
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./services/order_service/:/app
      - ./shared/:/app/shared
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/delivery
      - SECRET_KEY=${SECRET_KEY:-demo-secret-key-change-in-production}
      - TRACKING_SERVICE_URL=http://tracking-service:8300
      - NOTIFICATION_SERVICE_URL=http://notification-service:8400
      - ASSIGNMENT_SERVICE_URL=http://assignment-service:8900
    command: /bin/sh -c "pip install -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8500"
    ports:
      - "8500:8500"
    depends_on:
      postgres:
        condition: service_healthy

  notification-service:
    image: python:3.11-slim
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./services/notification_service/:/app
      - ./shared/:/app/shared
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/delivery
      - SECRET_KEY=${SECRET_KEY:-demo-secret-key-change-in-production}
      - HUBTEL_CLIENT_ID=${HUBTEL_CLIENT_ID}
      - HUBTEL_CLIENT_SECRET=${HUBTEL_CLIENT_SECRET}
      - HUBTEL_SMS_SENDER=${HUBTEL_SMS_SENDER}
      - HUBTEL_SMS_API=${HUBTEL_SMS_API}
    command: /bin/sh -c "pip install -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8400"
    ports:
      - "8400:8400"
    depends_on:
      postgres:
        condition: service_healthy

  assignment-service:
    image: python:3.11-slim
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./services/assignment_service/:/app
      - ./shared/:/app/shared
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/delivery
      - SECRET_KEY=${SECRET_KEY:-demo-secret-key-change-in-production}
      - TRACKING_SERVICE_URL=http://tracking-service:8300
      - NOTIFICATION_SERVICE_URL=http://notification-service:8400
    command: /bin/sh -c "pip install -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8900"
    ports:
      - "8900:8900"
    depends_on:
      postgres:
        condition: service_healthy

  review-service:
    image: python:3.11-slim
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./services/review_service/:/app
      - ./shared/:/app/shared
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/delivery
      - SECRET_KEY=${SECRET_KEY:-demo-secret-key-change-in-production}
    command: /bin/sh -c "pip install -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8700"
    ports:
      - "8700:8700"
    depends_on:
      postgres:
        condition: service_healthy

  rider-status-service:
    image: python:3.11-slim
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./services/rider_status_service/:/app
      - ./shared/:/app/shared
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/delivery
      - SECRET_KEY=${SECRET_KEY:-demo-secret-key-change-in-production}
    command: /bin/sh -c "pip install -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 8800"
    ports:
      - "8800:8800"
    depends_on:
      postgres:
        condition: service_healthy

  admin-ui:
    image: python:3.11-slim
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./services/admin_ui/:/app
      - ./shared/:/app/shared
      - ./services/downloads_server/apk:/app/apk
    environment:
      - AUTH_SERVICE_URL=http://auth-service:8600
      - PAYMENT_SERVICE_URL=http://payment-service:8200
      - ORDER_SERVICE_URL=http://order-service:8500
      - REVIEW_SERVICE_URL=http://review-service:8700
      - RIDER_STATUS_SERVICE_URL=http://rider-status-service:8800
      - ASSIGNMENT_SERVICE_URL=http://assignment-service:8900
      - BOOKING_SERVICE_URL=http://booking-service:8100
      - GOOGLE_MAPS_API_KEY=${GOOGLE_MAPS_API_KEY}
    command: /bin/sh -c "pip install -r requirements.txt && uvicorn main:app --host 0.0.0.0 --port 9000"
    ports:
      - "9000:9000"
    depends_on:
      - auth-service

  downloads-server:
    image: python:3.11-slim
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ./services/downloads_server/:/app
    command: /bin/sh -c "pip install -r requirements.txt && python main.py"
    ports:
      - "8750:8750"
    environment:
      - PORT=8750

volumes:
  pgdata:
